machine:
  # Nodejs
  node:
    version: v4.5.0
  # Java 8
  java:
    version: oraclejdk8
  # environment variables
  environment:
    JAVA_TOOL_OPTIONS: '-Dfile.encoding=UTF8 -Duser.timezone=UTC'
    _JAVA_OPTIONS: '-Xms512m -Xmx1024m -Xss2m'
    PATH: ${PATH}:${HOME}/activator-1.3.11-minimal/bin
    SEFURI_SF_DB_URL: 'jdbc:mysql://localhost:3306/sfr_sf?characterEncoding=utf-8&useSSL=false'
    SEFURI_SF_DB_USR: 'sefuri'
    SEFURI_SF_DB_PWD: '123'

dependencies:
  pre:
    - if [[ ! -e ~/activator-1.3.11-minimal/ ]]; then wget https://downloads.typesafe.com/typesafe-activator/1.3.11/typesafe-activator-1.3.11-minimal.zip && unzip typesafe-activator-1.3.11-minimal.zip -d ~; fi
    - cd public; rm -rf ./node_modules; npm install # install node packages

  override:
    - cd public; npm build # build client
    - activator clean compile:
        timeout: 180 # fail if command has no output for 3 minutes

  cache_directories:
    - "~/activator-1.3.11-minimal" # activator
    - "~/.sbt" # cache sbt packages
    - "~/.npm" # cache node packages

database:
  override:
    - mysql -u ubuntu -e "CREATE USER 'sefuri'@'localhost' IDENTIFIED BY '123';"
    - mysql -u ubuntu -e "GRANT ALL PRIVILEGES ON * . * TO 'sefuri'@'localhost';"
    - mysql -u ubuntu -e "FLUSH PRIVILEGES;"
    - mysql -u ubuntu circle_test < ./conf/sql/structure_20170301.sql

test:
  override:
    - activator test
  # Run these commands after the "override" commands
  post:
    # Copy test reports to Circle test reports dir
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - find . -type f -regex ".*/target/test-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;

## build branches
general:
  branches:
    only:
      - /release/